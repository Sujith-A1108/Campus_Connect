name: Android CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run unit tests
        run: ./gradlew test --no-daemon

      - name: Start Android emulator and run instrumentation tests
        uses: reactivecircus/android-emulator-runner@v2
        env:
          ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL: '600' # allow up to 10 minutes for boot
        with:
          api-level: 31
          target: google_apis
          arch: x86_64
          avd: pixel_5a
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot-load -no-audio
          timeout: 600000
          script: |
            set -eux
            echo "Installing Node.js and firebase-tools"
            curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash - && sudo apt-get install -y nodejs
            npm install -g firebase-tools

            echo "Starting Firestore emulator in background"
            nohup firebase emulators:start --only firestore --project demo-project --host 127.0.0.1 --port 8080 > firestore_emulator.log 2>&1 &

            echo "Waiting for Firestore emulator to be available"
            for i in {1..30}; do
              if grep -q "All emulators ready" firestore_emulator.log 2>/dev/null; then break; fi
              sleep 2
            done

            echo "Seeding emulator with demo data"
            FIRESTORE_EMULATOR_HOST=127.0.0.1:8080 node functions/seed_emulator.js || true

            echo "Waiting for Android emulator to boot"
            adb wait-for-device
            for i in {1..120}; do
              boot=$(adb -s emulator-5554 shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || true)
              if [ "$boot" = "1" ]; then
                echo "Emulator booted"
                break
              fi
              sleep 2
            done

            echo "Listing connected devices"
            adb devices -l

            echo "Running instrumentation tests"
            ./gradlew :app:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.package=com.example.campus_connect --no-daemon || true

      - name: Assemble debug
        run: ./gradlew :app:assembleDebug -x lint --no-daemon
