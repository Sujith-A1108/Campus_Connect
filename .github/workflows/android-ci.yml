name: Android CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run unit tests
        run: ./gradlew test --no-daemon

      - name: Start Android emulator and run instrumentation tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: google_apis
          arch: x86_64
          emulator-options: -no-window -gpu swiftshader_indirect
          script: |
            # Install Node and Firebase CLI to run Firestore emulator and seed data
            curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash - && sudo apt-get install -y nodejs
            npm install -g firebase-tools

            # Start Firestore emulator in background and wait a bit
            nohup firebase emulators:start --only firestore --project demo-project --host 127.0.0.1 --port 8080 > firestore_emulator.log 2>&1 &
            sleep 6

            # Seed the emulator with a demo post
            FIRESTORE_EMULATOR_HOST=127.0.0.1:8080 node functions/seed_emulator.js

            # Run instrumentation tests (device will connect to 10.0.2.2 to reach host firestore)
            ./gradlew :app:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.package=com.example.campus_connect --no-daemon

      - name: Assemble debug
        run: ./gradlew :app:assembleDebug -x lint --no-daemon
